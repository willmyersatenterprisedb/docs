---
title: 'Recovery'
originalFilePath: 'src/recovery.md'
---

In EDB Postgres Distributed for Kubernetes (PG4K-PGD), recovery is available as a way
to bootstrap a new PGD Group starting from an available physical backup of a PGD Node.
The recovery cannot be performed "in-place" on an existing PGD Group.
PG4K-PGD also supports Point In Time Recovery, which allows you to restore a PGDGroup up to
any point in time, from the first available backup in your catalog to the last archived
WAL (having a WAL archive is mandatory in this case).

## Prerequisite

Before recovering from a Backup, take care to apply the following considerations:

-   Make sure that the PostgreSQL configuration (`.spec.cnp.postgresql.parameters`) of the
    recovered cluster is compatible, from a physical replication standpoint, with the original one.

-   When recovering in a newly created namespace, remember to first setup a cert-manager CA Issuer before deploying the recovered PGDGroup.

For further information, refer to the [PG4K Recovery - Additional considerations](https://www.enterprisedb.com/docs/postgres_for_kubernetes/latest/bootstrap/#additional-considerations) documentation section.

## Recovery from an object store

You can recover from a PGD Node backup created by Barman Cloud and stored on supported object storage.

For example, given a PGDGroup named `pgdgroup-example` with 3 instances, with Backups available, your object storage
should contain a directory for each node:

`pgdgroup-example-1`, `pgdgroup-example-2`, `pgdgroup-example-3`

The following example will define a full recovery from the object store.
The operator will transparently select the latest backup between the defined `serverNames`, and
replay up to the last available WAL.

```yaml
apiVersion: pgd.k8s.enterprisedb.io/v1beta1
kind: PGDGroup
metadata:
  name: pgdgroup-restore
spec:
  [...]
  restore:
    serverNames:
      - pgdgroup-backup-1
      - pgdgroup-backup-2
      - pgdgroup-backup-3
    barmanObjectStore:
      destinationPath: "<destination path here>"
      s3Credentials:
        accessKeyId:
          name: backup-storage-creds
          key: ID
        secretAccessKey:
          name: backup-storage-creds
          key: KEY
      wal:
        compression: gzip
        encryption: AES256
        maxParallel: 8
```

!!! Important
    Make sure to correctly configure the WAL section according to the source cluster.
    In the above example, since the `pgdgroup-example` PGDGroup uses `compression`
    and `encryption`, make sure to set the proper parameters also in the PGDGroup
    that's being created by the `restore`.

!!! Note
    In the above example we are taking advantage of the parallel WAL restore feature,
    dedicating up to 8 jobs to concurrently fetch the required WAL files from the archive.
    This feature can appreciably reduce the recovery time. Make sure that you plan ahead
    for this scenario and tune the value of this parameter for your environment.
    It will certainly make a difference when you'll need it.

## Point in time recovery (PITR) from an object store

Instead of replaying all the WALs up to the latest one, we can ask PostgreSQL to stop replaying
WALs at any given point in time, after having extracted a base backup.
PostgreSQL uses this technique to achieve point-in-time recovery (PITR).
The presence of a WAL archive is mandatory.

The following example will define a time base target for the recovery:

```yaml
apiVersion: pgd.k8s.enterprisedb.io/v1beta1
kind: PGDGroup
metadata:
  name: pgdgroup-restore
spec:
  [...]
  restore:
    recoveryTarget:
      targetTime: "2023-08-11 11:14:21.00000+02"
    serverNames:
      - pgdgroup-backup-1
      - pgdgroup-backup-2
      - pgdgroup-backup-3
    barmanObjectStore:
      destinationPath: "<destination path here>"
      s3Credentials:
        accessKeyId:
          name: backup-storage-creds
          key: ID
        secretAccessKey:
          name: backup-storage-creds
          key: KEY
      wal:
        compression: gzip
        encryption: AES256
        maxParallel: 8
```

!!! Important
    PITR requires you to specify a `targetTime` recovery target, by using the options described
    in the "Recovery targets" section below. When you use `targetTime` or `targetLSN`, the operator
    automatically selects the closest backup that was completed before that target. Otherwise, it
    selects the last available backup in chronological order between the specified `serverNames`.

## Recovery from an object store specifying a `backupID`

The `.spec.restore.recoveryTarget.backupID` option allows you to specify a base backup from
which to initiate the recovery process. By default, this value is empty.
If you assign a value to it (in the form of a Barman backup ID), the operator will use that backup as base for the recovery.

The following example recovers a new PGDGroup from a specific backupID of the
`pgdgroup-backup-1` PGD Node:

```yaml
apiVersion: pgd.k8s.enterprisedb.io/v1beta1
kind: PGDGroup
metadata:
  name: pgdgroup-restore
spec:
  [...]
  restore:
    recoveryTarget:
      backupID: 20230824T133000
    serverNames:
      - pgdgroup-backup-1
    barmanObjectStore:
      destinationPath: "<destination path here>"
      s3Credentials:
        accessKeyId:
          name: backup-storage-creds
          key: ID
        secretAccessKey:
          name: backup-storage-creds
          key: KEY
      wal:
        compression: gzip
        encryption: AES256
        maxParallel: 8
```

!!! Important
    When a `backupID` is specified, make sure to only define the related PGD Node
    in the `serverNames` option, and avoid defining the other ones.

!!! Note
    Defining a specific `backupID` is especially needed when using one of the
    following recovery targets: `targetName`, `targetXID`, and `targetImmediate`.
    In such cases, it is important to specify `backupID`, unless you are OK with
    the last available backup in the catalog.

## Recovery targets

Beyond PITR there are other recovery target criteria you can use.
For more information on all the available Recovery Targets you can
refer to the [PG4K Recovery targets](https://www.enterprisedb.com/docs/postgres_for_kubernetes/latest/bootstrap/#point-in-time-recovery-pitr)
documentation (end of paragraph).